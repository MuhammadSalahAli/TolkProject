"use strict";var escapeRe=require("escape-string-regexp"),path=require("path"),builtinReporters=require("./reporters"),growl=require("./growl"),utils=require("./utils"),mocharc=require("./mocharc.json"),errors=require("./errors"),Suite=require("./suite"),createStatsCollector=require("./stats-collector"),createInvalidReporterError=errors.createInvalidReporterError,createInvalidInterfaceError=errors.createInvalidInterfaceError,EVENT_FILE_PRE_REQUIRE=Suite.constants.EVENT_FILE_PRE_REQUIRE,EVENT_FILE_POST_REQUIRE=Suite.constants.EVENT_FILE_POST_REQUIRE,EVENT_FILE_REQUIRE=Suite.constants.EVENT_FILE_REQUIRE,sQuote=utils.sQuote;if(exports=module.exports=Mocha,!process.browser){var cwd=process.cwad();module.paths.push(cwd,path.join(cwd,"node_modules"))}function Mocha(e){e=utils.assign({},mocharc,e||{}),this.files=[],this.options=e,this.suite=new exports.Suite("",new exports.Context,!0),this.grep(e.grep).fgrep(e.fgrep).ui(e.ui).reporter(e.reporter,e.reporterOption||e.reporterOptions).slow(e.slow).global(e.global),void 0!==e.timeout&&this.timeout(!1===e.timeout?0:e.timeout),"retries"in e&&this.retries(e.retries),["allowUncaught","asyncOnly","bail","checkLeaks","color","delay","diff","forbidOnly","forbidPending","fullTrace","growl","inlineDiffs","invert"].forEach(function(t){e[t]&&this[t]()},this)}exports.utils=utils,exports.interfaces=require("./interfaces"),exports.reporters=builtinReporters,exports.Runnable=require("./runnable"),exports.Context=require("./context"),exports.Runner=require("./runner"),exports.Suite=Suite,exports.Hook=require("./hook"),exports.Test=require("./test"),Mocha.prototype.bail=function(e){return this.suite.bail(!1!==e),this},Mocha.prototype.addFile=function(e){return this.files.push(e),this},Mocha.prototype.reporter=function(e,t){if("function"==typeof e)this._reporter=e;else{var o;if(builtinReporters[e=e||"spec"]&&(o=builtinReporters[e]),!o)try{o=require(e)}catch(t){if("MODULE_NOT_FOUND"!==t.code||-1!==t.message.indexOf("Cannot find module"))try{o=require(path.resolve(process.cwd(),e))}catch(o){"MODULE_NOT_FOUND"!==o.code||-1!==o.message.indexOf("Cannot find module")?console.warn(sQuote(e)+" reporter not found"):console.warn(sQuote(e)+" reporter blew up with error:\n"+t.stack)}else console.warn(sQuote(e)+" reporter blew up with error:\n"+t.stack)}if(!o)throw createInvalidReporterError("invalid reporter "+sQuote(e),e);this._reporter=o}return this.options.reporterOption=t,this.options.reporterOptions=t,this},Mocha.prototype.ui=function(e){var t;if("function"==typeof e)t=e;else if(e=e||"bdd",!(t=exports.interfaces[e]))try{t=require(e)}catch(t){throw createInvalidInterfaceError("invalid interface "+sQuote(e),e)}return t(this.suite),this.suite.on(EVENT_FILE_PRE_REQUIRE,function(e){exports.afterEach=e.afterEach||e.teardown,exports.after=e.after||e.suiteTeardown,exports.beforeEach=e.beforeEach||e.setup,exports.before=e.before||e.suiteSetup,exports.describe=e.describe||e.suite,exports.it=e.it||e.test,exports.xit=e.xit||e.test&&e.test.skip,exports.setup=e.setup||e.beforeEach,exports.suiteSetup=e.suiteSetup||e.before,exports.suiteTeardown=e.suiteTeardown||e.after,exports.suite=e.suite||e.describe,exports.teardown=e.teardown||e.afterEach,exports.test=e.test||e.it,exports.run=e.run}),this},Mocha.prototype.loadFiles=function(e){var t=this,o=this.suite;this.files.forEach(function(e){e=path.resolve(e),o.emit(EVENT_FILE_PRE_REQUIRE,global,e,t),o.emit(EVENT_FILE_REQUIRE,require(e),e,t),o.emit(EVENT_FILE_POST_REQUIRE,global,e,t)}),e&&e()},Mocha.unloadFile=function(e){delete require.cache[require.resolve(e)]},Mocha.prototype.unloadFiles=function(){return this.files.forEach(Mocha.unloadFile),this},Mocha.prototype.fgrep=function(e){return e?this.grep(new RegExp(escapeRe(e))):this},Mocha.prototype.grep=function(e){if(utils.isString(e)){var t=e.match(/^\/(.*)\/(g|i|)$|.*/);this.options.grep=new RegExp(t[1]||t[0],t[2])}else this.options.grep=e;return this},Mocha.prototype.invert=function(){return this.options.invert=!0,this},Mocha.prototype.ignoreLeaks=function(e){return utils.deprecate('"ignoreLeaks()" is DEPRECATED, please use "checkLeaks()" instead.'),this.options.checkLeaks=!e,this},Mocha.prototype.checkLeaks=function(e){return this.options.checkLeaks=!1!==e,this},Mocha.prototype.fullTrace=function(e){return this.options.fullTrace=!1!==e,this},Mocha.prototype.growl=function(){if(this.options.growl=this.isGrowlCapable(),!this.options.growl){var e=process.browser?"notification support not available in this browser...":"notification support prerequisites not installed...";console.error(e+" cannot enable!")}return this},Mocha.prototype.isGrowlCapable=growl.isCapable,Mocha.prototype._growl=growl.notify,Mocha.prototype.global=function(e){return this.options.global=(this.options.global||[]).concat(e).filter(Boolean).filter(function(e,t,o){return o.indexOf(e)===t}),this},Mocha.prototype.globals=Mocha.prototype.global,Mocha.prototype.useColors=function(e){return utils.deprecate('"useColors()" is DEPRECATED, please use "color()" instead.'),void 0!==e&&(this.options.color=e),this},Mocha.prototype.color=function(e){return this.options.color=!1!==e,this},Mocha.prototype.useInlineDiffs=function(e){return utils.deprecate('"useInlineDiffs()" is DEPRECATED, please use "inlineDiffs()" instead.'),this.options.inlineDiffs=void 0!==e&&e,this},Mocha.prototype.inlineDiffs=function(e){return this.options.inlineDiffs=!1!==e,this},Mocha.prototype.hideDiff=function(e){return utils.deprecate('"hideDiff()" is DEPRECATED, please use "diff()" instead.'),this.options.diff=!(!0===e),this},Mocha.prototype.diff=function(e){return this.options.diff=!1!==e,this},Mocha.prototype.timeout=function(e){return this.suite.timeout(e),this},Mocha.prototype.retries=function(e){return this.suite.retries(e),this},Mocha.prototype.slow=function(e){return this.suite.slow(e),this},Mocha.prototype.enableTimeouts=function(e){return this.suite.enableTimeouts(!arguments.length||void 0===e||e),this},Mocha.prototype.asyncOnly=function(e){return this.options.asyncOnly=!1!==e,this},Mocha.prototype.noHighlighting=function(){return this.options.noHighlighting=!0,this},Mocha.prototype.allowUncaught=function(e){return this.options.allowUncaught=!1!==e,this},Mocha.prototype.delay=function(){return this.options.delay=!0,this},Mocha.prototype.forbidOnly=function(e){return this.options.forbidOnly=!1!==e,this},Mocha.prototype.forbidPending=function(e){return this.options.forbidPending=!1!==e,this},Object.defineProperty(Mocha.prototype,"version",{value:require("../package.json").version,configurable:!1,enumerable:!0,writable:!1}),Mocha.prototype.run=function(e){this.files.length&&this.loadFiles();var t=this.suite,o=this.options;o.files=this.files;var r=new exports.Runner(t,o.delay);createStatsCollector(r);var i=new this._reporter(r,o);return r.checkLeaks=!0===o.checkLeaks,r.fullStackTrace=o.fullTrace,r.asyncOnly=o.asyncOnly,r.allowUncaught=o.allowUncaught,r.forbidOnly=o.forbidOnly,r.forbidPending=o.forbidPending,o.grep&&r.grep(o.grep,o.invert),o.global&&r.globals(o.global),o.growl&&this._growl(r),void 0!==o.color&&(exports.reporters.Base.useColors=o.color),exports.reporters.Base.inlineDiffs=o.inlineDiffs,exports.reporters.Base.hideDiff=!o.diff,r.run(function(t){e=e||utils.noop,i.done?i.done(t,e):e(t)})};